name: Build and Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite execu√ß√£o manual

# Configurar permiss√µes para GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Permitir apenas um deploy por vez
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Create GitHub Pages index.html
        run: |
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Zeev SLA Blocker - M√≥dulo JavaScript</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                      color: #333;
                  }
                  .code-block {
                      background: #f4f4f4;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                      padding: 15px;
                      margin: 20px 0;
                      overflow-x: auto;
                  }
                  .highlight {
                      background: #fff3cd;
                      padding: 10px;
                      border-radius: 5px;
                      border-left: 4px solid #ffc107;
                      margin: 15px 0;
                  }
                  .success {
                      background: #d4edda;
                      border-left: 4px solid #28a745;
                  }
              </style>
          </head>
          <body>
              <h1>üöÄ Zeev SLA Blocker</h1>
              
              <p>Este √© um m√≥dulo JavaScript ES que exibe um modal com tarefas de corre√ß√£o pendentes.</p>
              
              <div class="highlight success">
                  <h3>‚úÖ M√≥dulo Dispon√≠vel</h3>
                  <p>O m√≥dulo est√° dispon√≠vel nesta URL:</p>
                  <div class="code-block">
                      <code>https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/main.js</code>
                  </div>
              </div>
              
              <h2>üìñ Como Usar</h2>
              <p>Adicione esta linha no final do <code>&lt;body&gt;</code> da sua p√°gina HTML:</p>
              
              <div class="code-block">
                  <code>&lt;script type="module" src="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/main.js?key=SUA_CHAVE"&gt;&lt;/script&gt;</code>
              </div>
              
              <div class="highlight">
                  <h3>‚ö†Ô∏è Importante</h3>
                  <ul>
                      <li>Substitua <code>SUA_CHAVE</code> pela sua chave de licen√ßa v√°lida</li>
                      <li>O modal s√≥ aparece se a URL contiver <code>/my</code> E <code>/services</code></li>
                  </ul>
              </div>
              
              <h2>üîß Funcionalidades</h2>
              <ul>
                  <li>‚úÖ Verifica√ß√£o autom√°tica de URL</li>
                  <li>üîê Valida√ß√£o de licen√ßa via API</li>
                  <li>üé® Modal responsivo com Tailwind CSS</li>
                  <li>üì± Ocupa 70% da tela</li>
                  <li>üõ°Ô∏è Overlay bloqueante</li>
                  <li>‚ö° CSS e HTML embutidos no JavaScript</li>
              </ul>
              
              <h2>üìÑ Documenta√ß√£o</h2>
              <p>Para mais informa√ß√µes, consulte o <a href="https://github.com/${{ github.repository }}">reposit√≥rio no GitHub</a>.</p>
              
              <hr>
              <p><small>¬© 2025 Antonio Juevan - Licen√ßa MIT</small></p>
          </body>
          </html>
          EOF
        
      - name: Verify build output
        run: |
          echo "Verificando arquivos de build:"
          ls -la dist/
          echo "Conte√∫do do main.js (primeiros 200 caracteres):"
          head -c 200 dist/main.js
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
